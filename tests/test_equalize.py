import unittest
import numpy as np
from helper import rnbinom

import edgepy

@unittest.skip("unimplemented")
class test_equalize(unittest.TestCase):

    def test_q2qnbinom(self):
        y = np.array(rnbinom(80, size=5, mu=20, seed=42)).reshape((20,4))
        y = np.vstack(([0,0,0,0], [0,0,2,2], y))
        dispersion = 0.05
        input_mean = np.ones(shape=(22,4))
        output_mean = np.ones(shape=(22,4))

        res = edgepy.q2qnbinom(y, input_mean=input_mean, output_mean=output_mean, dispersion=dispersion)
        ref = np.array([
                0.2762531,0.2762531,0.2762531,0.2762531,
                0.2762531,0.2762531,3.4966287,3.4966287,
                33.0974396,25.4972788,15.2976294,30.5671423,
                14.0133232,22.9564745,14.0133232,22.9564745,
                19.1353251,45.7173628,35.6252450,3.4966287,
                20.4105762,10.1375367,36.8883203,38.1508926,
                26.7660766,20.4105762,43.1967478,33.0974396,
                10.1375367,45.7173628,36.8883203,36.8883203,
                20.4105762,19.1353251,25.4972788,21.6842336,
                7.5237817,31.8326263,29.3009323,39.4129937,
                45.7173628,28.0339341,19.1353251,29.3009323,
                17.8582671,29.3009323,20.4105762,25.4972788,
                44.4572300,29.3009323,10.1375367,38.1508926,
                39.4129937,41.9358961,22.9564745,17.8582671,
                34.3616312,20.4105762,30.5671423,34.3616312,
                26.7660766,33.0974396,49.4958438,49.4958438,
                22.9564745,26.7660766,17.8582671,20.4105762,
                12.7257033,62.0741373,45.7173628,11.4340845,
                53.2717700,28.0339341,54.5299057,22.9564745,
                50.7547512,43.1967478,52.0133891,33.0974396,
                28.0339341,26.7660766,29.3009323,43.1967478,
                22.9564745,25.4972788,30.5671423,24.2274474
            ]).reshape(22,4)
        #print(np.isclose(res, ref, atol=1e-6, rtol=0))
        print(res)
        self.assertTrue(np.allclose(res, ref, atol=1e-6, rtol=0))

if __name__ == '__main__':
    unittest.main()
